name: Tier 1 - Dashboard Data Collection

on:
  schedule:
    # Runs every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch:  # Allows manual triggering

jobs:
  collect-dashboard-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Load encrypted environment variables
      run: |
        python -c "
        from env_manager import EncryptedEnvManager
        import os
        
        # Load encrypted .env file
        encryption_key = os.getenv('ENV_ENCRYPTION_KEY')
        if encryption_key and os.path.exists('.env.encrypted'):
            manager = EncryptedEnvManager(encryption_key)
            env_vars = manager.load_encrypted_env('.env.encrypted')
            print(f'Loaded {len(env_vars)} environment variables from encrypted file')
        else:
            print('Using GitHub secrets fallback')
        "
      env:
        ENV_ENCRYPTION_KEY: ${{ secrets.ENV_ENCRYPTION_KEY }}
        
    - name: Run Tier 1 data collection
      run: python collect_tier1.py
      env:
        # Encryption key for .env file
        ENV_ENCRYPTION_KEY: ${{ secrets.ENV_ENCRYPTION_KEY }}
        
        # Supabase credentials (fallback if not in .env)
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        
    - name: Log completion
      run: echo "Tier 1 data collection completed at $(date)"

